<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Code Editor - SkillPort Community</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .CodeMirror { height: 400px; border-radius: 8px; }
    .test-case { transition: all 0.3s ease; }
    .test-case:hover { transform: translateY(-2px); }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-white to-blue-50 min-h-screen">
  <!-- Navbar -->
  <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-xl border-b border-slate-200/50 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center gap-2 group">
          <div class="w-8 h-8 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center group-hover:scale-105 transition-transform">
            <i data-lucide="sparkles" class="w-5 h-5 text-white"></i>
          </div>
          <span class="text-xl font-bold bg-gradient-to-r from-slate-900 to-slate-600 bg-clip-text text-transparent">
            SkillPort
          </span>
        </div>
        <div class="hidden md:flex items-center gap-1">
          <a href="../index.html" class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-50">
            <i data-lucide="home" class="w-4 h-4"></i> Home
          </a>
          <a href="user-dashboard.html" class="flex items-center gap-2 px-3 py-2 rounded-lg text-slate-600 hover:text-slate-900 hover:bg-slate-50 px-3 py-2 rounded-lg text-sm font-medium">
            <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Dashboard
          </a>
          <a href="user-contests.html" class="flex items-center gap-2 px-3 py-2 rounded-lg text-slate-600 hover:text-slate-900 hover:bg-slate-50 px-3 py-2 rounded-lg text-sm font-medium">
            <i data-lucide="trophy" class="w-4 h-4"></i> Contests
          </a>
          <a href="code-editor.html" class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium bg-blue-50 text-blue-700 shadow-sm">
            <i data-lucide="terminal" class="w-4 h-4"></i> Code Editor
          </a>
        </div>
        <!-- Avatar -->
        <div class="relative">
          <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="User Avatar" class="w-9 h-9 rounded-full object-cover border-2 border-slate-200 cursor-pointer hover:border-blue-300 transition-colors">
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-slate-900 mb-2">Code Editor</h1>
      <p class="text-lg text-slate-600">Write, test, and submit your solutions with real-time feedback</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Problem Description -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow-lg p-6 sticky top-24">
          <h3 class="text-lg font-bold text-slate-900 mb-4">Problem: Problem #1</h3>
          <div class="space-y-4">
            <div>
              <h4 class="font-medium text-slate-900 mb-2">Description</h4>
              <p class="text-sm text-slate-600">Given an array of integers nums and an integer target, return indices of the two numbers such that they add up to target.</p>
            </div>
            <div>
              <h4 class="font-medium text-slate-900 mb-2">Example</h4>
              <div class="bg-slate-50 p-3 rounded text-sm">
                <p><strong>Input:</strong> nums = [2,7,11,15], target = 9</p>
                <p><strong>Output:</strong> [0,1]</p>
                <p><strong>Explanation:</strong> Because nums[0] + nums[1] == 9, we return [0, 1].</p>
              </div>
            </div>
            <div>
              <h4 class="font-medium text-slate-900 mb-2">Constraints</h4>
              <ul class="text-sm text-slate-600 space-y-1">
                <li>• 2 ≤ nums.length ≤ 10⁴</li>
                <li>• -10⁹ ≤ nums[i] ≤ 10⁹</li>
                <li>• -10⁹ ≤ target ≤ 10⁹</li>
                <li>• Only one valid answer exists</li>
              </ul>
            </div>
            <div>
              <h4 class="font-medium text-slate-900 mb-2">Difficulty</h4>
              <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-sm font-medium">Easy</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Code Editor & Output -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Language Selection & Controls -->
        <div class="bg-white rounded-lg shadow-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Language</label>
                <select id="language-select" class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="javascript">JavaScript</option>
                  <option value="python">Python</option>
                  <option value="java">Java</option>
                  <option value="cpp">C++</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Theme</label>
                <select id="theme-select" class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="default">Default</option>
                  <option value="monokai">Dark</option>
                </select>
              </div>
            </div>
            <div class="flex gap-2">
              <button id="run-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                <i data-lucide="play" class="w-4 h-4"></i> Run
              </button>
              <button id="submit-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                <i data-lucide="send" class="w-4 h-4"></i> Submit
              </button>
            </div>
          </div>
          
          <!-- Code Editor -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-slate-700 mb-2">Your Solution</label>
            <textarea id="code-editor"></textarea>
          </div>
        </div>

        <!-- Test Cases & Output -->
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-bold text-slate-900 mb-4">Test Cases & Output</h3>
          
          <!-- Test Cases -->
          <div class="mb-6">
            <h4 class="font-medium text-slate-900 mb-3">Test Cases</h4>
            <div class="space-y-3">
              <div class="test-case bg-slate-50 p-3 rounded">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-medium text-slate-700">Test Case 1</span>
                  <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs">Pending</span>
                </div>
                <p class="text-xs text-slate-600 mt-1">Input: nums = [2,7,11,15], target = 9</p>
                <p class="text-xs text-slate-600">Expected: [0,1]</p>
              </div>
              <div class="test-case bg-slate-50 p-3 rounded">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-medium text-slate-700">Test Case 2</span>
                  <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs">Pending</span>
                </div>
                <p class="text-xs text-slate-600 mt-1">Input: nums = [3,2,4], target = 6</p>
                <p class="text-xs text-slate-600">Expected: [1,2]</p>
              </div>
              <div class="test-case bg-slate-50 p-3 rounded">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-medium text-slate-700">Test Case 3</span>
                  <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs">Pending</span>
                </div>
                <p class="text-xs text-slate-600 mt-1">Input: nums = [3,3], target = 6</p>
                <p class="text-xs text-slate-600">Expected: [0,1]</p>
              </div>
            </div>
          </div>

          <!-- Output Console -->
          <div>
            <h4 class="font-medium text-slate-900 mb-3">Output Console</h4>
            <div id="output-console" class="bg-slate-900 text-green-400 p-4 rounded-lg font-mono text-sm h-32 overflow-y-auto">
              <div class="text-slate-400">// Ready to run your code...</div>
            </div>
          </div>
        </div>

        <!-- Results & Statistics -->
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-bold text-slate-900 mb-4">Results</h3>
          <div class="grid grid-cols-3 gap-4">
            <div class="text-center p-4 bg-slate-50 rounded-lg">
              <div class="text-2xl font-bold text-slate-900" id="test-passed">0</div>
              <div class="text-sm text-slate-600">Tests Passed</div>
            </div>
            <div class="text-center p-4 bg-slate-50 rounded-lg">
              <div class="text-2xl font-bold text-slate-900" id="test-failed">0</div>
              <div class="text-sm text-slate-600">Tests Failed</div>
            </div>
            <div class="text-center p-4 bg-slate-50 rounded-lg">
              <div class="text-2xl font-bold text-slate-900" id="execution-time">0ms</div>
              <div class="text-sm text-slate-600">Execution Time</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Notification Container -->
  <div id="notification-container" class="fixed top-4 right-4 z-50"></div>

  <!-- Load API and App scripts -->
                  <script src="../js/api.js"></script>
                <script src="../js/app.js"></script>

  <script>
    lucide.createIcons();
    
    // Code Editor Page Controller
    class CodeEditorPage {
      constructor() {
        this.api = window.SkillPortAPI;
        this.editor = null;
        this.currentProblem = null;
        this.testCases = [];
        this.results = {
          passed: 0,
          failed: 0,
          executionTime: 0
        };
        this.init();
      }

      async init() {
        try {
          // Check if user is authenticated
          if (!this.api.isAuthenticated()) {
            window.location.href = '../index.html';
            return;
          }

          // Initialize CodeMirror editor
          this.initializeEditor();
          
          // Load problem data from URL parameters
          await this.loadProblemData();
          
          // Setup event listeners
          this.setupEventListeners();
          
        } catch (error) {
          console.error('Code editor initialization failed:', error);
          this.showError('Failed to initialize code editor');
        }
      }

      initializeEditor() {
        this.editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
          mode: 'javascript',
          theme: 'default',
          lineNumbers: true,
          autoCloseBrackets: true,
          matchBrackets: true,
          indentUnit: 2,
          tabSize: 2,
          lineWrapping: true,
          extraKeys: {
            'Ctrl-Space': 'autocomplete'
          }
        });

        // Set default code
        this.setDefaultCode('javascript');
      }

      async loadProblemData() {
        try {
          // Get problem ID from URL parameters
          const urlParams = new URLSearchParams(window.location.search);
          const problemId = urlParams.get('problem') || urlParams.get('contest');
          
          if (problemId) {
            const response = await this.api.getProblemDetails(problemId);
            if (response.success) {
              this.currentProblem = response.data.problem;
              this.testCases = response.data.testCases || [];
              this.updateProblemDisplay();
              this.updateTestCasesDisplay();
            }
          } else {
            // Load default problem or show problem selection
            this.loadDefaultProblem();
          }
        } catch (error) {
          console.error('Failed to load problem data:', error);
          this.loadDefaultProblem();
        }
      }

      loadDefaultProblem() {
        // Set a default problem for demonstration
        this.currentProblem = {
          id: 'default',
          title: 'Problem #1',
          description: 'Given an array of integers nums and an integer target, return indices of the two numbers such that they add up to target.',
          difficulty: 'Easy',
          constraints: [
            '2 ≤ nums.length ≤ 10⁴',
            '-10⁹ ≤ nums[i] ≤ 10⁹',
            '-10⁹ ≤ target ≤ 10⁹',
            'Only one valid answer exists'
          ]
        };

        this.testCases = [
          {
            id: 1,
            input: 'nums = [2,7,11,15], target = 9',
            expected: '[0,1]',
            status: 'pending'
          },
          {
            id: 2,
            input: 'nums = [3,2,4], target = 6',
            expected: '[1,2]',
            status: 'pending'
          },
          {
            id: 3,
            input: 'nums = [3,3], target = 6',
            expected: '[0,1]',
            status: 'pending'
          }
        ];

        this.updateProblemDisplay();
        this.updateTestCasesDisplay();
      }

      updateProblemDisplay() {
        if (!this.currentProblem) return;

        const elements = {
          title: document.querySelector('h3'),
          description: document.querySelector('.space-y-4 > div:first-child p'),
          difficulty: document.querySelector('.px-2.py-1')
        };

        if (elements.title) elements.title.textContent = `Problem: ${this.currentProblem.title}`;
        if (elements.description) elements.description.textContent = this.currentProblem.description;
        
        if (elements.difficulty && this.currentProblem.difficulty) {
          elements.difficulty.textContent = this.currentProblem.difficulty;
          const difficultyColors = {
            'Easy': 'bg-green-100 text-green-700',
            'Medium': 'bg-yellow-100 text-yellow-700',
            'Hard': 'bg-red-100 text-red-700'
          };
          elements.difficulty.className = `px-2 py-1 ${difficultyColors[this.currentProblem.difficulty] || 'bg-gray-100 text-gray-700'} rounded text-sm font-medium`;
        }
      }

      updateTestCasesDisplay() {
        const testCasesContainer = document.querySelector('.space-y-3');
        if (!testCasesContainer) return;

        testCasesContainer.innerHTML = this.testCases.map(testCase => `
          <div class="test-case bg-slate-50 p-3 rounded">
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium text-slate-700">Test Case ${testCase.id}</span>
              <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs">${testCase.status}</span>
            </div>
            <p class="text-xs text-slate-600 mt-1">Input: ${testCase.input}</p>
            <p class="text-xs text-slate-600">Expected: ${testCase.expected}</p>
          </div>
        `).join('');
      }

      setupEventListeners() {
        // Language selection
        document.getElementById('language-select').addEventListener('change', (e) => {
          this.handleLanguageChange(e.target.value);
        });

        // Theme selection
        document.getElementById('theme-select').addEventListener('change', (e) => {
          this.handleThemeChange(e.target.value);
        });

        // Run button
        document.getElementById('run-btn').addEventListener('click', () => {
          this.runCode();
        });

        // Submit button
        document.getElementById('submit-btn').addEventListener('click', () => {
          this.submitSolution();
        });
      }

      handleLanguageChange(language) {
        const modeMap = {
          'javascript': 'javascript',
          'python': 'python',
          'java': 'text/x-java-source',
          'cpp': 'text/x-c++src'
        };
        
        this.editor.setOption('mode', modeMap[language] || 'javascript');
        this.setDefaultCode(language);
      }

      handleThemeChange(theme) {
        this.editor.setOption('theme', theme === 'monokai' ? 'monokai' : 'default');
      }

      setDefaultCode(language) {
        const defaultCode = {
          'javascript': `function twoSum(nums, target) {
  // Your solution here
  // Example: return [0, 1];
}

// Test the function
console.log(twoSum([2, 7, 11, 15], 9));`,
          'python': `def two_sum(nums, target):
    # Your solution here
    # Example: return [0, 1]
    pass

# Test the function
print(two_sum([2, 7, 11, 15], 9))`,
          'java': `public class Solution {
    public int[] twoSum(int[] nums, int target) {
        // Your solution here
        // Example: return new int[]{0, 1};
        return new int[]{};
    }
    
    public static void main(String[] args) {
        Solution solution = new Solution();
        int[] result = solution.twoSum(new int[]{2, 7, 11, 15}, 9);
        System.out.println(Arrays.toString(result));
    }
}`,
          'cpp': `#include <iostream>
#include <vector>
using namespace std;

class Solution {
public:
    vector<int> twoSum(vector<int>& nums, int target) {
        // Your solution here
        // Example: return {0, 1};
        return {};
    }
};

int main() {
    Solution solution;
    vector<int> nums = {2, 7, 11, 15};
    int target = 9;
    vector<int> result = solution.twoSum(nums, target);
    
    cout << "[" << result[0] << ", " << result[1] << "]" << endl;
    return 0;
}`
        };
        
        this.editor.setValue(defaultCode[language] || defaultCode['javascript']);
      }

      async runCode() {
        const code = this.editor.getValue();
        const language = document.getElementById('language-select').value;
        const outputConsole = document.getElementById('output-console');
        
        outputConsole.innerHTML = '<div class="text-blue-400">// Running code...</div>';
        
        try {
          const startTime = performance.now();
          
          // Execute code through API
          const response = await this.api.executeCode({
            code,
            language,
            testCases: this.testCases
          });

          if (response.success) {
            const executionTime = Math.round(performance.now() - startTime);
            this.results.executionTime = executionTime;
            
            // Update output console
            outputConsole.innerHTML = '<div class="text-green-400">// Code executed successfully!</div>';
            if (response.data.output) {
              outputConsole.innerHTML += `<div class="text-green-400">${response.data.output}</div>`;
            }
            
            // Update test results
            this.updateTestResults(response.data.testResults);
            
          } else {
            outputConsole.innerHTML += `<div class="text-red-400">// Error: ${response.message}</div>`;
          }
          
        } catch (error) {
          console.error('Code execution failed:', error);
          outputConsole.innerHTML += `<div class="text-red-400">// Error: ${error.message}</div>`;
        }
      }

      updateTestResults(testResults) {
        if (!testResults) return;

        let passed = 0;
        let failed = 0;

        this.testCases.forEach((testCase, index) => {
          const result = testResults[index];
          const statusElement = document.querySelector(`.test-case:nth-child(${index + 1}) span:last-child`);
          
          if (result && result.passed) {
            statusElement.className = 'px-2 py-1 bg-green-100 text-green-700 rounded text-xs';
            statusElement.textContent = 'Passed';
            passed++;
          } else {
            statusElement.className = 'px-2 py-1 bg-red-100 text-red-700 rounded text-xs';
            statusElement.textContent = 'Failed';
            failed++;
          }
        });

        this.results.passed = passed;
        this.results.failed = failed;

        // Update results display
        document.getElementById('test-passed').textContent = passed;
        document.getElementById('test-failed').textContent = failed;
        document.getElementById('execution-time').textContent = `${this.results.executionTime}ms`;
      }

      async submitSolution() {
        try {
          const code = this.editor.getValue();
          const language = document.getElementById('language-select').value;
          
          if (!this.currentProblem) {
            this.showError('No problem selected for submission');
            return;
          }

          const response = await this.api.submitSolution({
            problemId: this.currentProblem.id,
            code,
            language,
            testResults: this.results
          });

          if (response.success) {
            this.showSuccess('Solution submitted successfully!');
            // Optionally redirect to results page or show detailed results
          } else {
            this.showError(response.message || 'Failed to submit solution');
          }
          
        } catch (error) {
          console.error('Solution submission failed:', error);
          this.showError('An error occurred while submitting your solution');
        }
      }

      // Utility functions
      showSuccess(message) {
        this.showNotification(message, 'success');
      }

      showError(message) {
        this.showNotification(message, 'error');
      }

      showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `p-4 rounded-lg shadow-lg ${
          type === 'success' ? 'bg-green-500 text-white' :
          type === 'error' ? 'bg-red-500 text-white' :
          'bg-blue-500 text-white'
        }`;
        notification.textContent = message;

        document.getElementById('notification-container').appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 3000);
      }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      window.codeEditorPage = new CodeEditorPage();
    });
  </script>
</body>
</html>
